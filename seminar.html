<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Seminar - Teknik Mesin Unsri</title>
    
    <!-- Bootstrap CSS -->
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .form-container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .form-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .form-body {
            padding: 40px;
        }
        .auth-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: 20px;
        }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            color: white;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            color: white;
        }
        .requirement-item {
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .loading-spinner {
            text-align: center;
            color: white;
        }
        .file-upload-area {
            border: 2px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload-area:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        .file-upload-area.dragover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        .file-info {
            display: none;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        .file-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <div class="spinner-border" style="width: 4rem; height: 4rem;" role="status"></div>
            <h4 class="mt-3" id="loadingText">Memverifikasi identitas Anda...</h4>
        </div>
    </div>

    <div class="form-container">
        <div class="form-header">
            <h1><i class="fas fa-presentation me-2"></i>Pendaftaran Seminar</h1>
            <p class="mb-0">Jurusan Teknik Mesin - Universitas Sriwijaya</p>
        </div>
        
        <div class="form-body">
            <!-- Auth Status -->
            <div id="authStatus" class="text-center mb-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Memverifikasi autentikasi...</p>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Main Form -->
            <form id="seminarForm" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="nama" class="form-label">Nama Lengkap <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nama" name="nama" required>
                    </div>
                    <div class="col-md-6">
                        <label for="nim" class="form-label">NIM <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="nim" name="nim" required>
                    </div>
                    <div class="col-12">
                        <label for="judul" class="form-label">Judul Seminar <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="judul" name="judul" rows="3" placeholder="Masukkan judul lengkap seminar Anda" required></textarea>
                    </div>
                    <div class="col-12">
                        <label for="pembimbing" class="form-label">Dosen Pembimbing <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="pembimbing" name="pembimbing" placeholder="Nama Dosen Pembimbing" required>
                    </div>

                    <!-- File Upload Area -->
                    <div class="col-12">
                        <label class="form-label">Upload File PDF <span class="text-danger">*</span></label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                            <h5>Klik atau Drag & Drop File PDF</h5>
                            <p class="text-muted mb-0">Ukuran maksimal: 10MB</p>
                            <input type="file" id="fileInput" accept="application/pdf" style="display: none;" required>
                        </div>
                        <div class="file-info" id="fileInfo">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="fas fa-file-pdf text-danger me-2"></i>
                                    <strong id="fileName">-</strong>
                                    <span class="text-muted ms-2" id="fileSize">-</span>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="removeFile">
                                    <i class="fas fa-times"></i> Hapus
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-12">
                        <label for="email" class="form-label">Email Institusi <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="email" name="email" readonly style="background-color: #e9ecef;">
                        <small class="text-muted">Email ini otomatis terisi dari akun Google yang Anda gunakan</small>
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary btn-submit w-100" id="btnSubmit">
                            <i class="fas fa-paper-plane me-2"></i>Kirim Pendaftaran
                        </button>
                    </div>
                </div>
            </form>

            <!-- Requirements -->
            <div class="mt-5">
                <h5 class="mb-3"><i class="fas fa-clipboard-check me-2"></i>Syarat & Ketentuan</h5>
                <div class="requirement-item">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    File harus dalam format PDF
                </div>
                <div class="requirement-item">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Ukuran file maksimal 10 MB
                </div>
                <div class="requirement-item">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    Pastikan data yang diisi sudah benar
                </div>
                <div class="requirement-item">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    File yang diupload tidak bisa dihapus setelah submit
                </div>
            </div>
        </div>
    </div>

    <!-- Monitoring Table -->
    <div class="form-container mt-4">
        <div class="form-header">
            <h3><i class="fas fa-table me-2"></i>Monitoring Status Pendaftaran</h3>
        </div>
        <div class="p-3">
            <div class="ratio ratio-16x9" style="max-height: 600px;">
                <iframe 
                    src="https://docs.google.com/spreadsheets/d/12vp90tJRTecge-7G0H06bL4RGJqtGwpNdgTBNd3STdw/preview?widget=true&headers=false"
                    frameborder="0">
                </iframe>
            </div>
        </div>
    </div>

    <script>
        let userEmail = null;
        let selectedFile = null;

        // Check authentication on page load
        window.addEventListener('load', function() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            google.script.run
                .withSuccessHandler(onAuthSuccess)
                .withFailureHandler(onAuthFailure)
                .getUserEmail();
        });

        function onAuthSuccess(response) {
            document.getElementById('loadingOverlay').style.display = 'none';
            
            if (response.success) {
                userEmail = response.email;
                
                // Show success badge
                document.getElementById('authStatus').innerHTML = `
                    <div class="auth-badge">
                        <i class="fas fa-check-circle me-2"></i>
                        Autentikasi Berhasil: <strong>${response.email}</strong>
                    </div>
                `;
                
                // Fill email field
                document.getElementById('email').value = response.email;
                
                // Show form
                document.getElementById('seminarForm').style.display = 'block';
                
            } else {
                showError(response.message);
            }
        }

        function onAuthFailure(error) {
            document.getElementById('loadingOverlay').style.display = 'none';
            showError(error.message || 'Terjadi kesalahan saat verifikasi');
        }

        function showError(message) {
            document.getElementById('authStatus').innerHTML = '';
            document.getElementById('alertContainer').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Akses Ditolak!</strong><br>
                    ${message}<br><br>
                    <small>Pastikan Anda login dengan akun Google <strong>@unsri.ac.id</strong> atau <strong>@student.unsri.ac.id</strong></small>
                </div>
            `;
        }

        // File Upload Handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const removeFileBtn = document.getElementById('removeFile');

        fileUploadArea.addEventListener('click', () => fileInput.click());

        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', () => {
            fileUploadArea.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        removeFileBtn.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('show');
        });

        function handleFileSelect(file) {
            // Validate file type
            if (file.type !== 'application/pdf') {
                alert('❌ File harus dalam format PDF!');
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('❌ Ukuran file maksimal 10 MB!');
                return;
            }

            selectedFile = file;
            
            // Show file info
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            fileInfo.classList.add('show');
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Form submission
        document.getElementById('seminarForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedFile) {
                alert('❌ Silakan upload file PDF terlebih dahulu!');
                return;
            }
            
            // Show loading
            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('loadingText').textContent = 'Mengupload file dan mengirim data...';
            document.getElementById('btnSubmit').disabled = true;
            
            // Read file as base64
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result.split(',')[1];
                
                const formData = {
                    nama: document.getElementById('nama').value,
                    nim: document.getElementById('nim').value,
                    judul: document.getElementById('judul').value,
                    pembimbing: document.getElementById('pembimbing').value
                };
                
                const fileData = {
                    data: base64Data,
                    fileName: selectedFile.name,
                    mimeType: selectedFile.type
                };
                
                // Submit to Apps Script
                google.script.run
                    .withSuccessHandler(onSubmitSuccess)
                    .withFailureHandler(onSubmitError)
                    .submitSeminarForm(formData, fileData);
            };
            
            reader.readAsDataURL(selectedFile);
        });

        function onSubmitSuccess(response) {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('btnSubmit').disabled = false;
            
            if (response.result === 'success') {
                alert('✅ BERHASIL!\n\n' + (response.message || 'Data pendaftaran seminar telah tersimpan.') + '\n\nFile Anda: ' + response.fileUrl);
                
                // Reset form
                document.getElementById('seminarForm').reset();
                document.getElementById('email').value = userEmail;
                selectedFile = null;
                fileInfo.classList.remove('show');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                alert('❌ GAGAL!\n\n' + response.error);
            }
        }

        function onSubmitError(error) {
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('btnSubmit').disabled = false;
            alert('❌ Terjadi kesalahan: ' + error.message);
        }
    </script>
</body>
</html>